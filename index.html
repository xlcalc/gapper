<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Gapped text for vocab learning</title>
<meta name="description" content="A free tool for language learners to create gapped text.">
<meta name="keywords" content="gapped, text, language, learners, vocabulary">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="./icon.png">

<style>
body {font-family: sans-serif}

footer {padding-top: 2em}

h1 {
  margin: 0.3em 0;
  text-align: center;
  font-size: 180%;
  color: #555;
}

p {
  margin: 4px;
}

hr {
  border-top: 1px silver solid;
  margin-bottom: 1em;
}

.text-box {
  margin: auto;
  margin-bottom: 1em;
  height: 400px;
  width: 900px;
  max-width: 75vw;
  font-size: 20px;
  overflow-y:auto;
  background-color: #fbfefb; 
  border: 1px silver solid;
  outline-color: silver;
  padding: 2px;
}

</style>

<link rel="stylesheet" type="text/css" href="main.css">

</head>

<body>
<div class="overlay"></div>

<div>
  <h1>Make gapped texts for vocab learning</h1>
  
  <div id="tbox" class="text-box" contenteditable="true"></div>
</div>

<div class="flex-center hmargin-2em">
  <div>Edit <label class='switch'><input id="gap-switch" type="checkbox" onchange="setBoxMode(this.checked)"><span class='slider round'></span></label> Gap mode
  </div>
  <div id="copy-text-btn" class="btn-darker" onclick="copyPlainText()">Copy plain text</div>
  <a id="audiodrill-link" href="https://audiodrill.com?tts-read" target="_blank">Open in Audiodrill</a>
</div>

<footer>
<hr>
<div class="flex-center hmargin-2em">
<!--<p>A free text gapper for <a href="https://audiodrill.com">Audiodrill</a></p>
-->

<p>Copyright 2022 xlcalc</p>
<p><a href="https://github.com/xlcalc/gapper">Repo on GitHub</a></p>

</div>
</footer>
<script>

const gapText = '___';
const elSel = q => document.querySelector(q);
const tbox = elSel('.text-box');
const auLink = elSel('#audiodrill-link');
const gapSwitch = elSel('#gap-switch');
const boxPrompt = `
You can use this free web tool to create cloze exercises to help students learn vocabulary.
<br><br>
Enter or paste a text into this text box, then switch from Edit to Gap mode and click on the 
words you wish to gap. Or select part of the word to gap only this part. To undo the gap, click on it again. Copy the result as plain text or open it in Audiodrill.
`;

document.addEventListener('DOMContentLoaded', event => {
  tbox.focus();
  tbox.innerHTML = boxPrompt;
//  addEventListener("selectionchange", handleSel);
//  setBoxMode(1);
});


const makeGap = el => {
  if (!gapSwitch.checked) return;
  const gapped = el.getAttribute('x-gapped');
  if (gapped) {
    el.textContent = gapped;
	el.removeAttribute('x-gapped');
  }
  else {
    const sel = window.getSelection();
//  const txt = sel.toString();
    const start = sel.anchorOffset;
    const end = sel.focusOffset;
    const txt = el.textContent;

    el.setAttribute('x-gapped', el.textContent);
//    el.textContent = gapText;

    if (start < end) el.textContent = txt.substring(0, start) + gapText + txt.substring(end);
    if (start > end) el.textContent = txt.substring(0, end) + gapText + txt.substring(start);
    if (start === end) el.textContent = gapText;
  }
  setAuLink();
}

const setAuLink = () => {
  auLink.setAttribute('href', getAuLink());
}

const isGapMode = () => elSel('#gap-switch').checked;
//const getBoxMode = () => (tbox.contentEditable === 'true') ? 'EDIT' : 'GAP';

/*
const getWordsWrappedOld = s => s .replace(/&nbsp;/g, ' ') // insterted by Chrome on entering a space
	  .replace(/<div><br><\/div>/g, '::') // empty new line insterted by Chrome on pressing Enter
	  .replace(/(?<=.)<div>/g, '::') // non-empty new line (not first line)
	  .replace(/<div>/g, '')
	  .replace(/<\/div>/g, '')
	  .replace(/<br>/g, '::')
//	  .replace(/\n/g, '\n::')
	  .replace(/\n/g, '::')
	  .replace(/\w+/g, s=>'<span onclick="makeGap(this)">'+s+'</span>')
	  .replace(/::/g, '<br>'); // restore new line
*/

const getWordsWrapped = s => s // to be used with .innerText only
	  .replace(/\w+/g, s=>'<span onclick="makeGap(this)">'+s+'</span>')
	  .replace(/\n\n\n/g, '\n\n') // Chrome inserts \n\n on empty line
	  .replace(/\n/g, '<br>');


const setBoxMode = v => {
  tbox.focus();
  if (v) {
    tbox.classList.add('gap-style');
    tbox.innerHTML = getWordsWrapped(tbox.innerText);
//    tbox.innerHTML = getWordsWrapped(tbox.textContent);
//    tbox.innerHTML = textToSpans(tbox); // doesn't work well yet.
//    tbox.contentEditable = 'false';
//    setAuLink();
  }
  else {
    tbox.classList.remove('gap-style');
	tbox.innerHTML = nodesToText(tbox, 'SCREEN_TEXT');
//	tbox.textContent = nodesToText(tbox, 'SCREEN_TEXT');
  }
//  else tbox.contentEditable = 'true';

  setAuLink();
}

/*
const textToSpans = (el) => {
  let s = '';
  for (node of el.childNodes) {
    if (node.nodeName === '#text') {
	  s += node.textContent. replace(/\w+/g, s=>'<span onclick="makeGap(this)">'+s+'</span>');
	} else s += node.innerHTML;
	
    console.log(s);
  }
  return s;
}
*/

const nodesToText = (el, mode = '') => {
// if gaps are off, copy just .innerText for plain text? Or just disable buttons to copy?
  let s = '';
  for (node of el.childNodes) {
    if ((node.nodeName === 'SPAN') && (node.getAttribute('x-gapped')) && (mode === 'SCREEN_TEXT')) {
	  s += node.textContent;
	} else if ((node.nodeName === 'SPAN') && (node.getAttribute('x-gapped')) && (mode !== 'PLAIN_TEXT')) {
      const addText = (node.textContent === gapText) ? '' : '=>' + node.textContent;
      s += '<<' + node.getAttribute('x-gapped') + addText + '>>'
	} else if (node.nodeName === 'BR') {
	  if (mode === 'SCREEN_TEXT') s += '\n<br>';
	  else s += '\n';
	} else s += node.textContent;
	
//    console.log(s);
  }
  return s;
}

const linkCopiedMsg = 'Link copied to clipboard';

const encode64 = s => btoa(unescape(encodeURIComponent(s)));

const getAuLink = () => 'https://audiodrill.com?tts-read&read-enc=' + encode64(nodesToText(tbox));

/*
const linkWithKey = key => {
  let url = `https://audiodrill.com?${key}&read-enc=` + encode64(nodesToText(tbox));
//  if (key === 'tts-read' && ta.splitBy && ta.splitBy !== 'chunks') url += '&split=' + ta.splitBy;
  copyToClipboard(url, linkCopiedMsg);
}
*/

const copyPlainText = () => {
  if (!isGapMode()) {
    displayMessage('Turn on gap mode before copying');
    return;
  }
  const txt = nodesToText(tbox, 'PLAIN_TEXT');
  copyToClipboard(txt, 'Text copied to clipboard');
}

const sleep = time => new Promise(resolve => setTimeout(resolve, time));

async function displayOverlay(msg='', intervalMsec, task) {
  const overlay = document.querySelector(".overlay");
  const closeBtn = '<div class="close-x btn" onclick="hitStopButton()">&times;</div>';
  overlay.style.display = msg ? "inline-block" : "none";

  msg += closeBtn;
  switch (task) {
    case 'clear after':
      overlay.innerHTML = msg;
      await sleep(intervalMsec);
      displayOverlay("");
      break;

    default:
      overlay.innerHTML = msg;
  }
}

const displayMessage = txt => { displayOverlay(txt, 2700, 'clear after'); }

const copyToClipboard = (txt, msg) => {
  navigator.clipboard.writeText(txt).then(
    () => { displayMessage(msg) },
    () => { displayMessage('Clipboard write failed') }
  );
}

</script>

</body>
</html>

<!--
BUGS:
- half fixed? more tests needed: line breaks in the text are lost when regime is changed 
- line breaks disappear when the text is opened in Audiodrill.

- the text crashes when the switch is turned on and off twice.

-->